<?php
// This script and data application were generated by AppGini 5.97
// Download AppGini for free from https://bigprof.com/appgini/download/

	$currDir = dirname(__FILE__);
	include_once("{$currDir}/lib.php");
	@include_once("{$currDir}/hooks/pams_mohon.php");
	include_once("{$currDir}/pams_mohon_dml.php");

	// mm: can the current member access this page?
	$perm = getTablePermissions('pams_mohon');
	if(!$perm['access']) {
		echo error_message($Translation['tableAccessDenied']);
		exit;
	}

	$x = new DataList;
	$x->TableName = 'pams_mohon';

	// Fields that can be displayed in the table view
	$x->QueryFieldsTV = [
		"`pams_mohon`.`ID`" => "ID",
		"IF(    CHAR_LENGTH(`tahun1`.`tahun`), CONCAT_WS('',   `tahun1`.`tahun`), '') /* Tahun */" => "tahun",
		"IF(    CHAR_LENGTH(`negeri1`.`nama_negeri`), CONCAT_WS('',   `negeri1`.`nama_negeri`), '') /* Negeri */" => "negeri",
		"`pams_mohon`.`Nama_Projek`" => "Nama_Projek",
		"IF(    CHAR_LENGTH(`daerah1`.`nama_daerah`), CONCAT_WS('',   `daerah1`.`nama_daerah`), '') /* Daerah */" => "Daerah",
		"IF(    CHAR_LENGTH(`PARLIMEN1`.`nama_parlimen`), CONCAT_WS('',   `PARLIMEN1`.`nama_parlimen`), '') /* Parlimen */" => "Parlimen",
		"IF(    CHAR_LENGTH(`Dun1`.`nama_dun`), CONCAT_WS('',   `Dun1`.`nama_dun`), '') /* DUN */" => "DUN",
		"`pams_mohon`.`sumber_mohon`" => "sumber_mohon",
		"`pams_mohon`.`status_tanah`" => "status_tanah",
		"IF(    CHAR_LENGTH(`skop_pams1`.`skop_pams`), CONCAT_WS('',   `skop_pams1`.`skop_pams`), '') /* Skop Kerja */" => "skop",
		"`pams_mohon`.`gambar_projek`" => "gambar_projek",
		"`pams_mohon`.`gambar_projek_2`" => "gambar_projek_2",
		"`pams_mohon`.`Peta`" => "Peta",
		"FORMAT(`pams_mohon`.`anggaran_kos`, 2)" => "anggaran_kos",
		"`pams_mohon`.`justifikasi`" => "justifikasi",
		"`pams_mohon`.`PenerimaManfaat`" => "PenerimaManfaat",
		"`pams_mohon`.`nama_mpkk_jpkkp`" => "nama_mpkk_jpkkp",
		"`pams_mohon`.`no_tel_mpkk_jpkkp`" => "no_tel_mpkk_jpkkp",
		"`pams_mohon`.`catatan`" => "catatan",
		"`pams_mohon`.`status_permohonan`" => "status_permohonan",
		"`pams_mohon`.`status_kelulusan`" => "status_kelulusan",
		"`pams_mohon`.`sumber_peruntukan`" => "sumber_peruntukan",
		"`pams_mohon`.`gambar_projek_3`" => "gambar_projek_3",
		"`pams_mohon`.`gambar_projek_1`" => "gambar_projek_1",
		"`pams_mohon`.`updated`" => "updated",
	];
	// mapping incoming sort by requests to actual query fields
	$x->SortFields = [
		1 => '`pams_mohon`.`ID`',
		2 => '`tahun1`.`tahun`',
		3 => '`negeri1`.`nama_negeri`',
		4 => 4,
		5 => '`daerah1`.`nama_daerah`',
		6 => '`PARLIMEN1`.`nama_parlimen`',
		7 => '`Dun1`.`nama_dun`',
		8 => 8,
		9 => 9,
		10 => '`skop_pams1`.`skop_pams`',
		11 => 11,
		12 => 12,
		13 => 13,
		14 => '`pams_mohon`.`anggaran_kos`',
		15 => 15,
		16 => 16,
		17 => 17,
		18 => 18,
		19 => 19,
		20 => 20,
		21 => '`pams_mohon`.`status_kelulusan`',
		22 => 22,
		23 => 23,
		24 => 24,
		25 => 25,
	];

	// Fields that can be displayed in the csv file
	$x->QueryFieldsCSV = [
		"`pams_mohon`.`ID`" => "ID",
		"IF(    CHAR_LENGTH(`tahun1`.`tahun`), CONCAT_WS('',   `tahun1`.`tahun`), '') /* Tahun */" => "tahun",
		"IF(    CHAR_LENGTH(`negeri1`.`nama_negeri`), CONCAT_WS('',   `negeri1`.`nama_negeri`), '') /* Negeri */" => "negeri",
		"`pams_mohon`.`Nama_Projek`" => "Nama_Projek",
		"IF(    CHAR_LENGTH(`daerah1`.`nama_daerah`), CONCAT_WS('',   `daerah1`.`nama_daerah`), '') /* Daerah */" => "Daerah",
		"IF(    CHAR_LENGTH(`PARLIMEN1`.`nama_parlimen`), CONCAT_WS('',   `PARLIMEN1`.`nama_parlimen`), '') /* Parlimen */" => "Parlimen",
		"IF(    CHAR_LENGTH(`Dun1`.`nama_dun`), CONCAT_WS('',   `Dun1`.`nama_dun`), '') /* DUN */" => "DUN",
		"`pams_mohon`.`sumber_mohon`" => "sumber_mohon",
		"`pams_mohon`.`status_tanah`" => "status_tanah",
		"IF(    CHAR_LENGTH(`skop_pams1`.`skop_pams`), CONCAT_WS('',   `skop_pams1`.`skop_pams`), '') /* Skop Kerja */" => "skop",
		"`pams_mohon`.`gambar_projek`" => "gambar_projek",
		"`pams_mohon`.`gambar_projek_2`" => "gambar_projek_2",
		"`pams_mohon`.`Peta`" => "Peta",
		"FORMAT(`pams_mohon`.`anggaran_kos`, 2)" => "anggaran_kos",
		"`pams_mohon`.`justifikasi`" => "justifikasi",
		"`pams_mohon`.`PenerimaManfaat`" => "PenerimaManfaat",
		"`pams_mohon`.`nama_mpkk_jpkkp`" => "nama_mpkk_jpkkp",
		"`pams_mohon`.`no_tel_mpkk_jpkkp`" => "no_tel_mpkk_jpkkp",
		"`pams_mohon`.`catatan`" => "catatan",
		"`pams_mohon`.`status_permohonan`" => "status_permohonan",
		"`pams_mohon`.`status_kelulusan`" => "status_kelulusan",
		"`pams_mohon`.`sumber_peruntukan`" => "sumber_peruntukan",
		"`pams_mohon`.`gambar_projek_3`" => "gambar_projek_3",
		"`pams_mohon`.`gambar_projek_1`" => "gambar_projek_1",
		"`pams_mohon`.`updated`" => "updated",
	];
	// Fields that can be filtered
	$x->QueryFieldsFilters = [
		"IF(    CHAR_LENGTH(`tahun1`.`tahun`), CONCAT_WS('',   `tahun1`.`tahun`), '') /* Tahun */" => "Tahun",
		"IF(    CHAR_LENGTH(`negeri1`.`nama_negeri`), CONCAT_WS('',   `negeri1`.`nama_negeri`), '') /* Negeri */" => "Negeri",
		"`pams_mohon`.`Nama_Projek`" => "Nama Projek",
		"IF(    CHAR_LENGTH(`daerah1`.`nama_daerah`), CONCAT_WS('',   `daerah1`.`nama_daerah`), '') /* Daerah */" => "Daerah",
		"IF(    CHAR_LENGTH(`PARLIMEN1`.`nama_parlimen`), CONCAT_WS('',   `PARLIMEN1`.`nama_parlimen`), '') /* Parlimen */" => "Parlimen",
		"IF(    CHAR_LENGTH(`Dun1`.`nama_dun`), CONCAT_WS('',   `Dun1`.`nama_dun`), '') /* DUN */" => "DUN",
		"`pams_mohon`.`sumber_mohon`" => "Sumber mohon",
		"`pams_mohon`.`status_tanah`" => "Status tanah",
		"IF(    CHAR_LENGTH(`skop_pams1`.`skop_pams`), CONCAT_WS('',   `skop_pams1`.`skop_pams`), '') /* Skop Kerja */" => "Skop Kerja",
		"`pams_mohon`.`Peta`" => "Peta",
		"`pams_mohon`.`anggaran_kos`" => "Kos projek",
		"`pams_mohon`.`justifikasi`" => "Justifikasi",
		"`pams_mohon`.`PenerimaManfaat`" => "Penerima Manfaat",
		"`pams_mohon`.`nama_mpkk_jpkkp`" => "Nama mpkk jpkkp",
		"`pams_mohon`.`no_tel_mpkk_jpkkp`" => "No tel mpkk jpkkp",
		"`pams_mohon`.`catatan`" => "Catatan",
		"`pams_mohon`.`status_permohonan`" => "Status permohonan",
		"`pams_mohon`.`status_kelulusan`" => "Status kelulusan",
		"`pams_mohon`.`sumber_peruntukan`" => "Sumber peruntukan",
		"`pams_mohon`.`updated`" => "Dikemaskini oleh",
	];

	// Fields that can be quick searched
	$x->QueryFieldsQS = [
		"IF(    CHAR_LENGTH(`tahun1`.`tahun`), CONCAT_WS('',   `tahun1`.`tahun`), '') /* Tahun */" => "tahun",
		"IF(    CHAR_LENGTH(`negeri1`.`nama_negeri`), CONCAT_WS('',   `negeri1`.`nama_negeri`), '') /* Negeri */" => "negeri",
		"`pams_mohon`.`Nama_Projek`" => "Nama_Projek",
		"IF(    CHAR_LENGTH(`daerah1`.`nama_daerah`), CONCAT_WS('',   `daerah1`.`nama_daerah`), '') /* Daerah */" => "Daerah",
		"IF(    CHAR_LENGTH(`PARLIMEN1`.`nama_parlimen`), CONCAT_WS('',   `PARLIMEN1`.`nama_parlimen`), '') /* Parlimen */" => "Parlimen",
		"IF(    CHAR_LENGTH(`Dun1`.`nama_dun`), CONCAT_WS('',   `Dun1`.`nama_dun`), '') /* DUN */" => "DUN",
		"`pams_mohon`.`sumber_mohon`" => "sumber_mohon",
		"`pams_mohon`.`status_tanah`" => "status_tanah",
		"IF(    CHAR_LENGTH(`skop_pams1`.`skop_pams`), CONCAT_WS('',   `skop_pams1`.`skop_pams`), '') /* Skop Kerja */" => "skop",
		"`pams_mohon`.`Peta`" => "Peta",
		"FORMAT(`pams_mohon`.`anggaran_kos`, 2)" => "anggaran_kos",
		"`pams_mohon`.`justifikasi`" => "justifikasi",
		"`pams_mohon`.`PenerimaManfaat`" => "PenerimaManfaat",
		"`pams_mohon`.`nama_mpkk_jpkkp`" => "nama_mpkk_jpkkp",
		"`pams_mohon`.`no_tel_mpkk_jpkkp`" => "no_tel_mpkk_jpkkp",
		"`pams_mohon`.`catatan`" => "catatan",
		"`pams_mohon`.`status_permohonan`" => "status_permohonan",
		"`pams_mohon`.`status_kelulusan`" => "status_kelulusan",
		"`pams_mohon`.`sumber_peruntukan`" => "sumber_peruntukan",
		"`pams_mohon`.`updated`" => "updated",
	];

	// Lookup fields that can be used as filterers
	$x->filterers = ['tahun' => 'Tahun', 'negeri' => 'Negeri', 'Daerah' => 'Daerah', 'Parlimen' => 'Parlimen', 'DUN' => 'DUN', 'skop' => 'Skop Kerja', ];

	$x->QueryFrom = "`pams_mohon` LEFT JOIN `tahun` as tahun1 ON `tahun1`.`id`=`pams_mohon`.`tahun` LEFT JOIN `negeri` as negeri1 ON `negeri1`.`id`=`pams_mohon`.`negeri` LEFT JOIN `daerah` as daerah1 ON `daerah1`.`id`=`pams_mohon`.`Daerah` LEFT JOIN `PARLIMEN` as PARLIMEN1 ON `PARLIMEN1`.`id`=`pams_mohon`.`Parlimen` LEFT JOIN `Dun` as Dun1 ON `Dun1`.`id`=`pams_mohon`.`DUN` LEFT JOIN `skop_pams` as skop_pams1 ON `skop_pams1`.`id`=`pams_mohon`.`skop` ";
	$x->QueryWhere = '';
	$x->QueryOrder = '';

	$x->AllowSelection = 1;
	$x->HideTableView = ($perm['view'] == 0 ? 1 : 0);
	$x->AllowDelete = $perm['delete'];
	$x->AllowMassDelete = (getLoggedAdmin() !== false);
	$x->AllowInsert = $perm['insert'];
	$x->AllowUpdate = $perm['edit'];
	$x->SeparateDV = 1;
	$x->AllowDeleteOfParents = 0;
	$x->AllowFilters = 1;
	$x->AllowSavingFilters = 1;
	$x->AllowSorting = 1;
	$x->AllowNavigation = 1;
	$x->AllowPrinting = 1;
	$x->AllowPrintingDV = (getLoggedAdmin() !== false);
	$x->AllowCSV = 1;
	$x->RecordsPerPage = 10;
	$x->QuickSearch = 1;
	$x->QuickSearchText = $Translation['quick search'];
	$x->ScriptFileName = 'pams_mohon_view.php';
	$x->RedirectAfterInsert = 'pams_mohon_view.php';
	$x->TableTitle = 'MOHON PAMS';
	$x->TableIcon = 'resources/table_icons/car_add.png';
	$x->PrimaryKey = '`pams_mohon`.`ID`';
	$x->DefaultSortField = '1';
	$x->DefaultSortDirection = 'asc';

	$x->ColWidth = [150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, ];
	$x->ColCaption = ['Tahun', 'Negeri', 'Nama Projek', 'Daerah', 'Parlimen', 'DUN', 'Sumber mohon', 'Status tanah', 'Skop Kerja', 'Gambar ', 'Gambar', 'Peta', 'Kos projek', 'Justifikasi', 'Penerima Manfaat', 'Catatan', 'Status permohonan', 'Status kelulusan', 'Sumber peruntukan', 'Gambar   ', 'Gambar   ', 'Dikemaskini oleh', ];
	$x->ColFieldName = ['tahun', 'negeri', 'Nama_Projek', 'Daerah', 'Parlimen', 'DUN', 'sumber_mohon', 'status_tanah', 'skop', 'gambar_projek', 'gambar_projek_2', 'Peta', 'anggaran_kos', 'justifikasi', 'PenerimaManfaat', 'catatan', 'status_permohonan', 'status_kelulusan', 'sumber_peruntukan', 'gambar_projek_3', 'gambar_projek_1', 'updated', ];
	$x->ColNumber  = [2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 19, 20, 21, 22, 23, 24, 25, ];

	// template paths below are based on the app main directory
	$x->Template = 'templates/pams_mohon_templateTV.html';
	$x->SelectedTemplate = 'templates/pams_mohon_templateTVS.html';
	$x->TemplateDV = 'templates/pams_mohon_templateDV.html';
	$x->TemplateDVP = 'templates/pams_mohon_templateDVP.html';

	$x->ShowTableHeader = 0;
	$x->TVClasses = "";
	$x->DVClasses = "";
	$x->HasCalculatedFields = true;
	$x->AllowConsoleLog = false;
	$x->AllowDVNavigation = true;

	// hook: pams_mohon_init
	$render = true;
	if(function_exists('pams_mohon_init')) {
		$args = [];
		$render = pams_mohon_init($x, getMemberInfo(), $args);
	}

	if($render) $x->Render();

	// column sums
	if(strpos($x->HTML, '<!-- tv data below -->')) {
		// if printing multi-selection TV, calculate the sum only for the selected records
		if(isset($_REQUEST['Print_x']) && is_array($_REQUEST['record_selector'])) {
			$QueryWhere = '';
			foreach($_REQUEST['record_selector'] as $id) {   // get selected records
				if($id != '') $QueryWhere .= "'" . makeSafe($id) . "',";
			}
			if($QueryWhere != '') {
				$QueryWhere = 'where `pams_mohon`.`ID` in ('.substr($QueryWhere, 0, -1).')';
			} else { // if no selected records, write the where clause to return an empty result
				$QueryWhere = 'where 1=0';
			}
		} else {
			$QueryWhere = $x->QueryWhere;
		}

		$sumQuery = "SELECT FORMAT(SUM(`pams_mohon`.`anggaran_kos`), 2) FROM {$x->QueryFrom} {$QueryWhere}";
		$res = sql($sumQuery, $eo);
		if($row = db_fetch_row($res)) {
			$sumRow = '<tr class="success sum">';
			if(!isset($_REQUEST['Print_x'])) $sumRow .= '<th class="text-center sum">&sum;</th>';
			$sumRow .= '<td class="pams_mohon-tahun sum"></td>';
			$sumRow .= '<td class="pams_mohon-negeri sum"></td>';
			$sumRow .= '<td class="pams_mohon-Nama_Projek sum"></td>';
			$sumRow .= '<td class="pams_mohon-Daerah sum"></td>';
			$sumRow .= '<td class="pams_mohon-Parlimen sum"></td>';
			$sumRow .= '<td class="pams_mohon-DUN sum"></td>';
			$sumRow .= '<td class="pams_mohon-sumber_mohon sum"></td>';
			$sumRow .= '<td class="pams_mohon-status_tanah sum"></td>';
			$sumRow .= '<td class="pams_mohon-skop sum"></td>';
			$sumRow .= '<td class="pams_mohon-gambar_projek sum"></td>';
			$sumRow .= '<td class="pams_mohon-gambar_projek_2 sum"></td>';
			$sumRow .= '<td class="pams_mohon-Peta sum"></td>';
			$sumRow .= "<td class=\"pams_mohon-anggaran_kos text-left sum\">{$row[0]}</td>";
			$sumRow .= '<td class="pams_mohon-justifikasi sum"></td>';
			$sumRow .= '<td class="pams_mohon-PenerimaManfaat sum"></td>';
			$sumRow .= '<td class="pams_mohon-catatan sum"></td>';
			$sumRow .= '<td class="pams_mohon-status_permohonan sum"></td>';
			$sumRow .= '<td class="pams_mohon-status_kelulusan sum"></td>';
			$sumRow .= '<td class="pams_mohon-sumber_peruntukan sum"></td>';
			$sumRow .= '<td class="pams_mohon-gambar_projek_3 sum"></td>';
			$sumRow .= '<td class="pams_mohon-gambar_projek_1 sum"></td>';
			$sumRow .= '<td class="pams_mohon-updated sum"></td>';
			$sumRow .= '</tr>';

			$x->HTML = str_replace('<!-- tv data below -->', '', $x->HTML);
			$x->HTML = str_replace('<!-- tv data above -->', $sumRow, $x->HTML);
		}
	}

	// hook: pams_mohon_header
	$headerCode = '';
	if(function_exists('pams_mohon_header')) {
		$args = [];
		$headerCode = pams_mohon_header($x->ContentType, getMemberInfo(), $args);
	}

	if(!$headerCode) {
		include_once("{$currDir}/header.php"); 
	} else {
		ob_start();
		include_once("{$currDir}/header.php");
		echo str_replace('<%%HEADER%%>', ob_get_clean(), $headerCode);
	}

	echo $x->HTML;

	// hook: pams_mohon_footer
	$footerCode = '';
	if(function_exists('pams_mohon_footer')) {
		$args = [];
		$footerCode = pams_mohon_footer($x->ContentType, getMemberInfo(), $args);
	}

	if(!$footerCode) {
		include_once("{$currDir}/footer.php"); 
	} else {
		ob_start();
		include_once("{$currDir}/footer.php");
		echo str_replace('<%%FOOTER%%>', ob_get_clean(), $footerCode);
	}
