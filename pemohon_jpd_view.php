<?php
// This script and data application were generated by AppGini 5.97
// Download AppGini for free from https://bigprof.com/appgini/download/

	$currDir = dirname(__FILE__);
	include_once("{$currDir}/lib.php");
	@include_once("{$currDir}/hooks/pemohon_jpd.php");
	include_once("{$currDir}/pemohon_jpd_dml.php");

	// mm: can the current member access this page?
	$perm = getTablePermissions('pemohon_jpd');
	if(!$perm['access']) {
		echo error_message($Translation['tableAccessDenied']);
		exit;
	}

	$x = new DataList;
	$x->TableName = 'pemohon_jpd';

	// Fields that can be displayed in the table view
	$x->QueryFieldsTV = [
		"`pemohon_jpd`.`ID`" => "ID",
		"IF(    CHAR_LENGTH(`tahun1`.`tahun`), CONCAT_WS('',   `tahun1`.`tahun`), '') /* Tahun */" => "tahun",
		"`pemohon_jpd`.`Nama_Projek`" => "Nama_Projek",
		"IF(    CHAR_LENGTH(`negeri1`.`nama_negeri`), CONCAT_WS('',   `negeri1`.`nama_negeri`), '') /* NEGERI */" => "negeri",
		"IF(    CHAR_LENGTH(`daerah1`.`nama_daerah`), CONCAT_WS('',   `daerah1`.`nama_daerah`), '') /* Daerah */" => "Daerah",
		"IF(    CHAR_LENGTH(`PARLIMEN1`.`nama_parlimen`), CONCAT_WS('',   `PARLIMEN1`.`nama_parlimen`), '') /* Parlimen */" => "Parlimen",
		"IF(    CHAR_LENGTH(`Dun1`.`nama_dun`), CONCAT_WS('',   `Dun1`.`nama_dun`), '') /* DUN */" => "DUN",
		"`pemohon_jpd`.`status_tanah`" => "status_tanah",
		"`pemohon_jpd`.`PanjangJalanM`" => "PanjangJalanM",
		"`pemohon_jpd`.`LebarM`" => "LebarM",
		"IF(    CHAR_LENGTH(`skop_jpd1`.`skop_jpd`), CONCAT_WS('',   `skop_jpd1`.`skop_jpd`), '') /* Skop */" => "skop",
		"`pemohon_jpd`.`gambar_projek`" => "gambar_projek",
		"`pemohon_jpd`.`gambar_projek_1`" => "gambar_projek_1",
		"`pemohon_jpd`.`sumber_mohon`" => "sumber_mohon",
		"`pemohon_jpd`.`Peta`" => "Peta",
		"FORMAT(`pemohon_jpd`.`anggaran_kos`, 2)" => "anggaran_kos",
		"`pemohon_jpd`.`justifikasi`" => "justifikasi",
		"`pemohon_jpd`.`PenerimaManfaat`" => "PenerimaManfaat",
		"`pemohon_jpd`.`nama_mpkk_jpkkp`" => "nama_mpkk_jpkkp",
		"`pemohon_jpd`.`no_tel_mpkk_jpkkp`" => "no_tel_mpkk_jpkkp",
		"`pemohon_jpd`.`catatan`" => "catatan",
		"`pemohon_jpd`.`status_permohonan`" => "status_permohonan",
		"`pemohon_jpd`.`status_kelulusan`" => "status_kelulusan",
		"`pemohon_jpd`.`sumber_peruntukan`" => "sumber_peruntukan",
		"`pemohon_jpd`.`updated`" => "updated",
		"`pemohon_jpd`.`gambar_projek2`" => "gambar_projek2",
		"`pemohon_jpd`.`gambar_projek3`" => "gambar_projek3",
	];
	// mapping incoming sort by requests to actual query fields
	$x->SortFields = [
		1 => '`pemohon_jpd`.`ID`',
		2 => '`tahun1`.`tahun`',
		3 => 3,
		4 => '`negeri1`.`nama_negeri`',
		5 => '`daerah1`.`nama_daerah`',
		6 => '`PARLIMEN1`.`nama_parlimen`',
		7 => '`Dun1`.`nama_dun`',
		8 => 8,
		9 => 9,
		10 => 10,
		11 => '`skop_jpd1`.`skop_jpd`',
		12 => 12,
		13 => 13,
		14 => 14,
		15 => 15,
		16 => '`pemohon_jpd`.`anggaran_kos`',
		17 => 17,
		18 => 18,
		19 => 19,
		20 => 20,
		21 => 21,
		22 => 22,
		23 => '`pemohon_jpd`.`status_kelulusan`',
		24 => 24,
		25 => 25,
		26 => 26,
		27 => 27,
	];

	// Fields that can be displayed in the csv file
	$x->QueryFieldsCSV = [
		"`pemohon_jpd`.`ID`" => "ID",
		"IF(    CHAR_LENGTH(`tahun1`.`tahun`), CONCAT_WS('',   `tahun1`.`tahun`), '') /* Tahun */" => "tahun",
		"`pemohon_jpd`.`Nama_Projek`" => "Nama_Projek",
		"IF(    CHAR_LENGTH(`negeri1`.`nama_negeri`), CONCAT_WS('',   `negeri1`.`nama_negeri`), '') /* NEGERI */" => "negeri",
		"IF(    CHAR_LENGTH(`daerah1`.`nama_daerah`), CONCAT_WS('',   `daerah1`.`nama_daerah`), '') /* Daerah */" => "Daerah",
		"IF(    CHAR_LENGTH(`PARLIMEN1`.`nama_parlimen`), CONCAT_WS('',   `PARLIMEN1`.`nama_parlimen`), '') /* Parlimen */" => "Parlimen",
		"IF(    CHAR_LENGTH(`Dun1`.`nama_dun`), CONCAT_WS('',   `Dun1`.`nama_dun`), '') /* DUN */" => "DUN",
		"`pemohon_jpd`.`status_tanah`" => "status_tanah",
		"`pemohon_jpd`.`PanjangJalanM`" => "PanjangJalanM",
		"`pemohon_jpd`.`LebarM`" => "LebarM",
		"IF(    CHAR_LENGTH(`skop_jpd1`.`skop_jpd`), CONCAT_WS('',   `skop_jpd1`.`skop_jpd`), '') /* Skop */" => "skop",
		"`pemohon_jpd`.`gambar_projek`" => "gambar_projek",
		"`pemohon_jpd`.`gambar_projek_1`" => "gambar_projek_1",
		"`pemohon_jpd`.`sumber_mohon`" => "sumber_mohon",
		"`pemohon_jpd`.`Peta`" => "Peta",
		"FORMAT(`pemohon_jpd`.`anggaran_kos`, 2)" => "anggaran_kos",
		"`pemohon_jpd`.`justifikasi`" => "justifikasi",
		"`pemohon_jpd`.`PenerimaManfaat`" => "PenerimaManfaat",
		"`pemohon_jpd`.`nama_mpkk_jpkkp`" => "nama_mpkk_jpkkp",
		"`pemohon_jpd`.`no_tel_mpkk_jpkkp`" => "no_tel_mpkk_jpkkp",
		"`pemohon_jpd`.`catatan`" => "catatan",
		"`pemohon_jpd`.`status_permohonan`" => "status_permohonan",
		"`pemohon_jpd`.`status_kelulusan`" => "status_kelulusan",
		"`pemohon_jpd`.`sumber_peruntukan`" => "sumber_peruntukan",
		"`pemohon_jpd`.`updated`" => "updated",
		"`pemohon_jpd`.`gambar_projek2`" => "gambar_projek2",
		"`pemohon_jpd`.`gambar_projek3`" => "gambar_projek3",
	];
	// Fields that can be filtered
	$x->QueryFieldsFilters = [
		"IF(    CHAR_LENGTH(`tahun1`.`tahun`), CONCAT_WS('',   `tahun1`.`tahun`), '') /* Tahun */" => "Tahun",
		"`pemohon_jpd`.`Nama_Projek`" => "Nama Projek",
		"IF(    CHAR_LENGTH(`negeri1`.`nama_negeri`), CONCAT_WS('',   `negeri1`.`nama_negeri`), '') /* NEGERI */" => "NEGERI",
		"IF(    CHAR_LENGTH(`daerah1`.`nama_daerah`), CONCAT_WS('',   `daerah1`.`nama_daerah`), '') /* Daerah */" => "Daerah",
		"IF(    CHAR_LENGTH(`PARLIMEN1`.`nama_parlimen`), CONCAT_WS('',   `PARLIMEN1`.`nama_parlimen`), '') /* Parlimen */" => "Parlimen",
		"IF(    CHAR_LENGTH(`Dun1`.`nama_dun`), CONCAT_WS('',   `Dun1`.`nama_dun`), '') /* DUN */" => "DUN",
		"`pemohon_jpd`.`status_tanah`" => "Status tanah",
		"`pemohon_jpd`.`PanjangJalanM`" => "Panjang Jalan (M)",
		"`pemohon_jpd`.`LebarM`" => "Lebar (M)",
		"IF(    CHAR_LENGTH(`skop_jpd1`.`skop_jpd`), CONCAT_WS('',   `skop_jpd1`.`skop_jpd`), '') /* Skop */" => "Skop",
		"`pemohon_jpd`.`sumber_mohon`" => "Sumber mohon",
		"`pemohon_jpd`.`Peta`" => "Peta",
		"`pemohon_jpd`.`anggaran_kos`" => "Kos projek",
		"`pemohon_jpd`.`justifikasi`" => "Justifikasi",
		"`pemohon_jpd`.`PenerimaManfaat`" => "Penerima Manfaat",
		"`pemohon_jpd`.`nama_mpkk_jpkkp`" => "Nama mpkk jpkkp",
		"`pemohon_jpd`.`no_tel_mpkk_jpkkp`" => "No tel mpkk jpkkp",
		"`pemohon_jpd`.`catatan`" => "Catatan",
		"`pemohon_jpd`.`status_permohonan`" => "Status permohonan",
		"`pemohon_jpd`.`status_kelulusan`" => "Status kelulusan",
		"`pemohon_jpd`.`sumber_peruntukan`" => "Sumber peruntukan",
		"`pemohon_jpd`.`updated`" => "Dikemaskini oleh",
	];

	// Fields that can be quick searched
	$x->QueryFieldsQS = [
		"IF(    CHAR_LENGTH(`tahun1`.`tahun`), CONCAT_WS('',   `tahun1`.`tahun`), '') /* Tahun */" => "tahun",
		"`pemohon_jpd`.`Nama_Projek`" => "Nama_Projek",
		"IF(    CHAR_LENGTH(`negeri1`.`nama_negeri`), CONCAT_WS('',   `negeri1`.`nama_negeri`), '') /* NEGERI */" => "negeri",
		"IF(    CHAR_LENGTH(`daerah1`.`nama_daerah`), CONCAT_WS('',   `daerah1`.`nama_daerah`), '') /* Daerah */" => "Daerah",
		"IF(    CHAR_LENGTH(`PARLIMEN1`.`nama_parlimen`), CONCAT_WS('',   `PARLIMEN1`.`nama_parlimen`), '') /* Parlimen */" => "Parlimen",
		"IF(    CHAR_LENGTH(`Dun1`.`nama_dun`), CONCAT_WS('',   `Dun1`.`nama_dun`), '') /* DUN */" => "DUN",
		"`pemohon_jpd`.`status_tanah`" => "status_tanah",
		"`pemohon_jpd`.`PanjangJalanM`" => "PanjangJalanM",
		"`pemohon_jpd`.`LebarM`" => "LebarM",
		"IF(    CHAR_LENGTH(`skop_jpd1`.`skop_jpd`), CONCAT_WS('',   `skop_jpd1`.`skop_jpd`), '') /* Skop */" => "skop",
		"`pemohon_jpd`.`sumber_mohon`" => "sumber_mohon",
		"`pemohon_jpd`.`Peta`" => "Peta",
		"FORMAT(`pemohon_jpd`.`anggaran_kos`, 2)" => "anggaran_kos",
		"`pemohon_jpd`.`justifikasi`" => "justifikasi",
		"`pemohon_jpd`.`PenerimaManfaat`" => "PenerimaManfaat",
		"`pemohon_jpd`.`nama_mpkk_jpkkp`" => "nama_mpkk_jpkkp",
		"`pemohon_jpd`.`no_tel_mpkk_jpkkp`" => "no_tel_mpkk_jpkkp",
		"`pemohon_jpd`.`catatan`" => "catatan",
		"`pemohon_jpd`.`status_permohonan`" => "status_permohonan",
		"`pemohon_jpd`.`status_kelulusan`" => "status_kelulusan",
		"`pemohon_jpd`.`sumber_peruntukan`" => "sumber_peruntukan",
		"`pemohon_jpd`.`updated`" => "updated",
	];

	// Lookup fields that can be used as filterers
	$x->filterers = ['tahun' => 'Tahun', 'negeri' => 'NEGERI', 'Daerah' => 'Daerah', 'Parlimen' => 'Parlimen', 'DUN' => 'DUN', 'skop' => 'Skop', ];

	$x->QueryFrom = "`pemohon_jpd` LEFT JOIN `tahun` as tahun1 ON `tahun1`.`id`=`pemohon_jpd`.`tahun` LEFT JOIN `negeri` as negeri1 ON `negeri1`.`id`=`pemohon_jpd`.`negeri` LEFT JOIN `daerah` as daerah1 ON `daerah1`.`id`=`pemohon_jpd`.`Daerah` LEFT JOIN `PARLIMEN` as PARLIMEN1 ON `PARLIMEN1`.`id`=`pemohon_jpd`.`Parlimen` LEFT JOIN `Dun` as Dun1 ON `Dun1`.`id`=`pemohon_jpd`.`DUN` LEFT JOIN `skop_jpd` as skop_jpd1 ON `skop_jpd1`.`id`=`pemohon_jpd`.`skop` ";
	$x->QueryWhere = '';
	$x->QueryOrder = '';

	$x->AllowSelection = 1;
	$x->HideTableView = ($perm['view'] == 0 ? 1 : 0);
	$x->AllowDelete = $perm['delete'];
	$x->AllowMassDelete = (getLoggedAdmin() !== false);
	$x->AllowInsert = $perm['insert'];
	$x->AllowUpdate = $perm['edit'];
	$x->SeparateDV = 1;
	$x->AllowDeleteOfParents = 0;
	$x->AllowFilters = 1;
	$x->AllowSavingFilters = 1;
	$x->AllowSorting = 1;
	$x->AllowNavigation = 1;
	$x->AllowPrinting = 1;
	$x->AllowPrintingDV = 1;
	$x->AllowCSV = 1;
	$x->RecordsPerPage = 10;
	$x->QuickSearch = 1;
	$x->QuickSearchText = $Translation['quick search'];
	$x->ScriptFileName = 'pemohon_jpd_view.php';
	$x->RedirectAfterInsert = 'pemohon_jpd_view.php?SelectedID=#ID#';
	$x->TableTitle = 'MOHON JPD';
	$x->TableIcon = 'resources/table_icons/car_add.png';
	$x->PrimaryKey = '`pemohon_jpd`.`ID`';
	$x->DefaultSortField = '1';
	$x->DefaultSortDirection = 'asc';

	$x->ColWidth = [150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, ];
	$x->ColCaption = ['Tahun', 'Nama Projek', 'NEGERI', 'Daerah', 'Parlimen', 'DUN', 'Status tanah', 'Panjang Jalan (M)', 'Lebar (M)', 'Skop', 'Gambar ', 'Gambar', 'Sumber mohon', 'Peta', 'Kos projek', 'Justifikasi', 'Penerima Manfaat', 'Catatan', 'Status permohonan', 'Status kelulusan', 'Sumber peruntukan', 'Dikemaskini oleh', 'Gambar  ', 'Gambar   ', ];
	$x->ColFieldName = ['tahun', 'Nama_Projek', 'negeri', 'Daerah', 'Parlimen', 'DUN', 'status_tanah', 'PanjangJalanM', 'LebarM', 'skop', 'gambar_projek', 'gambar_projek_1', 'sumber_mohon', 'Peta', 'anggaran_kos', 'justifikasi', 'PenerimaManfaat', 'catatan', 'status_permohonan', 'status_kelulusan', 'sumber_peruntukan', 'updated', 'gambar_projek2', 'gambar_projek3', ];
	$x->ColNumber  = [2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 21, 22, 23, 24, 25, 26, 27, ];

	// template paths below are based on the app main directory
	$x->Template = 'templates/pemohon_jpd_templateTV.html';
	$x->SelectedTemplate = 'templates/pemohon_jpd_templateTVS.html';
	$x->TemplateDV = 'templates/pemohon_jpd_templateDV.html';
	$x->TemplateDVP = 'templates/pemohon_jpd_templateDVP.html';

	$x->ShowTableHeader = 0;
	$x->TVClasses = "";
	$x->DVClasses = "";
	$x->HasCalculatedFields = true;
	$x->AllowConsoleLog = false;
	$x->AllowDVNavigation = true;

	// hook: pemohon_jpd_init
	$render = true;
	if(function_exists('pemohon_jpd_init')) {
		$args = [];
		$render = pemohon_jpd_init($x, getMemberInfo(), $args);
	}

	if($render) $x->Render();

	// column sums
	if(strpos($x->HTML, '<!-- tv data below -->')) {
		// if printing multi-selection TV, calculate the sum only for the selected records
		if(isset($_REQUEST['Print_x']) && is_array($_REQUEST['record_selector'])) {
			$QueryWhere = '';
			foreach($_REQUEST['record_selector'] as $id) {   // get selected records
				if($id != '') $QueryWhere .= "'" . makeSafe($id) . "',";
			}
			if($QueryWhere != '') {
				$QueryWhere = 'where `pemohon_jpd`.`ID` in ('.substr($QueryWhere, 0, -1).')';
			} else { // if no selected records, write the where clause to return an empty result
				$QueryWhere = 'where 1=0';
			}
		} else {
			$QueryWhere = $x->QueryWhere;
		}

		$sumQuery = "SELECT FORMAT(SUM(`pemohon_jpd`.`anggaran_kos`), 2) FROM {$x->QueryFrom} {$QueryWhere}";
		$res = sql($sumQuery, $eo);
		if($row = db_fetch_row($res)) {
			$sumRow = '<tr class="success sum">';
			if(!isset($_REQUEST['Print_x'])) $sumRow .= '<th class="text-center sum">&sum;</th>';
			$sumRow .= '<td class="pemohon_jpd-tahun sum"></td>';
			$sumRow .= '<td class="pemohon_jpd-Nama_Projek sum"></td>';
			$sumRow .= '<td class="pemohon_jpd-negeri sum"></td>';
			$sumRow .= '<td class="pemohon_jpd-Daerah sum"></td>';
			$sumRow .= '<td class="pemohon_jpd-Parlimen sum"></td>';
			$sumRow .= '<td class="pemohon_jpd-DUN sum"></td>';
			$sumRow .= '<td class="pemohon_jpd-status_tanah sum"></td>';
			$sumRow .= '<td class="pemohon_jpd-PanjangJalanM sum"></td>';
			$sumRow .= '<td class="pemohon_jpd-LebarM sum"></td>';
			$sumRow .= '<td class="pemohon_jpd-skop sum"></td>';
			$sumRow .= '<td class="pemohon_jpd-gambar_projek sum"></td>';
			$sumRow .= '<td class="pemohon_jpd-gambar_projek_1 sum"></td>';
			$sumRow .= '<td class="pemohon_jpd-sumber_mohon sum"></td>';
			$sumRow .= '<td class="pemohon_jpd-Peta sum"></td>';
			$sumRow .= "<td class=\"pemohon_jpd-anggaran_kos text-left sum\">{$row[0]}</td>";
			$sumRow .= '<td class="pemohon_jpd-justifikasi sum"></td>';
			$sumRow .= '<td class="pemohon_jpd-PenerimaManfaat sum"></td>';
			$sumRow .= '<td class="pemohon_jpd-catatan sum"></td>';
			$sumRow .= '<td class="pemohon_jpd-status_permohonan sum"></td>';
			$sumRow .= '<td class="pemohon_jpd-status_kelulusan sum"></td>';
			$sumRow .= '<td class="pemohon_jpd-sumber_peruntukan sum"></td>';
			$sumRow .= '<td class="pemohon_jpd-updated sum"></td>';
			$sumRow .= '<td class="pemohon_jpd-gambar_projek2 sum"></td>';
			$sumRow .= '<td class="pemohon_jpd-gambar_projek3 sum"></td>';
			$sumRow .= '</tr>';

			$x->HTML = str_replace('<!-- tv data below -->', '', $x->HTML);
			$x->HTML = str_replace('<!-- tv data above -->', $sumRow, $x->HTML);
		}
	}

	// hook: pemohon_jpd_header
	$headerCode = '';
	if(function_exists('pemohon_jpd_header')) {
		$args = [];
		$headerCode = pemohon_jpd_header($x->ContentType, getMemberInfo(), $args);
	}

	if(!$headerCode) {
		include_once("{$currDir}/header.php"); 
	} else {
		ob_start();
		include_once("{$currDir}/header.php");
		echo str_replace('<%%HEADER%%>', ob_get_clean(), $headerCode);
	}

	echo $x->HTML;

	// hook: pemohon_jpd_footer
	$footerCode = '';
	if(function_exists('pemohon_jpd_footer')) {
		$args = [];
		$footerCode = pemohon_jpd_footer($x->ContentType, getMemberInfo(), $args);
	}

	if(!$footerCode) {
		include_once("{$currDir}/footer.php"); 
	} else {
		ob_start();
		include_once("{$currDir}/footer.php");
		echo str_replace('<%%FOOTER%%>', ob_get_clean(), $footerCode);
	}
